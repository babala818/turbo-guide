<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å®æ—¶éŸ³é¢‘å…±äº« - æœåŠ¡å™¨è½¬å‘ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Helvetica Neue", Arial, sans-serif;
        }
        body {
            background: #121212;
            color: #ffffff;
            min-height: 100vh;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .container {
            width: 100%;
            margin: 0 auto;
            max-width: 500px;
        }
        h1 {
            text-align: center;
            font-size: 22px;
            color: #4ade80;
            margin-bottom: 8px;
        }
        .status {
            background: #1e1e1e;
            padding: 14px;
            border-radius: 10px;
            text-align: center;
            font-size: 15px;
            min-height: 45px;
            line-height: 1.4;
            white-space: pre-wrap;
        }
        .card {
            background: #2d2d2d;
            padding: 16px;
            border-radius: 10px;
            margin-top: 8px;
        }
        .card-title {
            color: #f59e0b;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 16px;
        }
        .card-content {
            font-size: 14px;
            line-height: 1.6;
            color: #d1d5db;
        }
        .role-select {
            display: flex;
            gap: 8px;
            margin: 8px 0;
        }
        .role-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
        }
        .host-btn {
            background: #f59e0b;
            color: white;
        }
        .client-btn {
            background: #3b82f6;
            color: white;
        }
        .mode-select {
            display: flex;
            gap: 8px;
            margin: 8px 0;
        }
        .mode-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
        }
        .system-mode {
            background: #10b981;
            color: white;
        }
        .mic-mode {
            background: #f59e0b;
            color: white;
        }
        .room-input {
            width: 100%;
            padding: 16px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            background: #3d3d3d;
            color: #fff;
            outline: none;
            margin: 8px 0;
            text-align: center;
            font-weight: 500;
            letter-spacing: 2px;
        }
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            background: #22c55e;
            color: white;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 8px;
        }
        .btn:disabled {
            background: #4b5563;
            cursor: not-allowed;
        }
        .btn-copy {
            background: #6366f1;
            padding: 10px;
            font-size: 14px;
        }
        .controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .control-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            background: #3b82f6;
            color: white;
            font-size: 16px;
            font-weight: 500;
        }
        .control-btn:disabled {
            background: #4b5563;
        }
        .tips {
            font-size: 13px;
            color: #9ca3af;
            text-align: center;
            margin-top: 8px;
        }
        .server-status {
            background: #1e3a8a;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
            margin-top: 8px;
        }
        .server-status.connected {
            background: #064e3b;
            color: #a7f3d0;
        }
        .server-status.connecting {
            background: #78350f;
            color: #fdba74;
        }
        .server-status.disconnected {
            background: #7f1d1d;
            color: #fca5a5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å®æ—¶éŸ³é¢‘å…±äº« - æœåŠ¡å™¨è½¬å‘ç‰ˆ</h1>
        <div class="status" id="status">ğŸ” åˆå§‹åŒ–ä¸­...è¯·ç¨ç­‰</div>
        
        <!-- è§’è‰²é€‰æ‹© -->
        <div class="role-select">
            <button class="role-btn host-btn" id="hostBtn">æˆ‘æ˜¯æ’­æ”¾æ–¹ï¼ˆä¼ éŸ³é¢‘ï¼‰</button>
            <button class="role-btn client-btn" id="clientBtn">æˆ‘æ˜¯æ”¶å¬æ–¹ï¼ˆå¬éŸ³é¢‘ï¼‰</button>
        </div>
        
        <!-- éŸ³é¢‘æ¨¡å¼é€‰æ‹©ï¼ˆæ’­æ”¾æ–¹ï¼‰ -->
        <div class="mode-select" id="modeSelect" style="display: none;">
            <button class="mode-btn system-mode" id="systemAudioBtn">ğŸµ ç³»ç»ŸéŸ³é¢‘ï¼ˆæ— æ‚éŸ³ï¼‰</button>
            <button class="mode-btn mic-mode" id="micAudioBtn">ğŸ¤ éº¦å…‹é£ï¼ˆå…œåº•ï¼‰</button>
        </div>
        
        <!-- æƒé™å¼•å¯¼ -->
        <div class="card" id="permGuide" style="display: none;">
            <div class="card-title">ğŸ“Œ æƒé™å¼€å¯æŒ‡å¼•</div>
            <div class="card-content" id="guideText">è¯·é€‰æ‹©éŸ³é¢‘æ•è·æ¨¡å¼ï¼ŒæŒ‰æç¤ºå¼€å¯å¯¹åº”æƒé™</div>
        </div>
        
        <!-- æˆ¿é—´å·è¾“å…¥ -->
        <div class="card" id="roomCard" style="display: none;">
            <div class="card-title" id="roomTitle">æˆ¿é—´å·</div>
            <input type="text" id="roomInput" class="room-input" placeholder="è¾“å…¥6ä½æˆ¿é—´å·æˆ–ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ" maxlength="6">
            <div class="server-status" id="serverStatus">ğŸŸ¡ è¿æ¥æœåŠ¡å™¨ä¸­...</div>
        </div>
        
        <!-- ä¼ å£°æ§åˆ¶ -->
        <div class="controls" id="controls" style="display: none;">
            <button class="control-btn" id="startBtn" disabled>å¼€å§‹ä¼ å£°</button>
            <button class="control-btn test-btn" id="testAudioBtn" disabled>æµ‹è¯•ä¼ å£°</button>
            <button class="control-btn" id="stopBtn" disabled>åœæ­¢ä¼ å£°</button>
        </div>
        
        <!-- éŸ³é¢‘æµ‹è¯• -->
        <div class="controls" id="audioTestControls" style="display: none;">
            <button class="control-btn" id="testAudioBtn">ğŸ”Š æµ‹è¯•éŸ³é¢‘</button>
        </div>
        
        <div class="tips">ğŸ’¡ æœåŠ¡å™¨è½¬å‘æ¨¡å¼ | æ— éœ€P2Pç©¿é€ | ç¨³å®šè¿æ¥ | åŒéŸ³é¢‘æ¨¡å¼</div>
    </div>

    <script>
        // æ ¸å¿ƒå˜é‡
        let socket = null;
        let audioStream = null;
        let audioTrack = null;
        let audioMode = "system";
        let isHost = false;
        let currentRoomId = null;
        let audioContext = null;
        let audioSource = null;
        let audioProcessor = null;
        let isSharing = false;
        
        // æˆ¿é—´ç®¡ç†
        let activeRooms = new Map(); // å­˜å‚¨æ´»è·ƒæˆ¿é—´
        let roomCreationTime = 0;    // æˆ¿é—´åˆ›å»ºæ—¶é—´
        let isLocalMode = true;      // ä½¿ç”¨æœ¬åœ°æ¨¡å¼ï¼ˆåŸºäºWebRTCå±€åŸŸç½‘ç›´è¿ï¼‰
        
        // WebRTCç›¸å…³å˜é‡
        let peerConnections = new Map(); // å­˜å‚¨å¯¹ç­‰è¿æ¥
        let localStream = null;         // æœ¬åœ°éŸ³é¢‘æµ
        let dataChannel = null;         // æ•°æ®é€šé“
        let isHost = false;             // æ˜¯å¦ä¸ºæ’­æ”¾æ–¹
        let currentRoomId = null;       // å½“å‰æˆ¿é—´ID
        let clientId = generateClientId(); // å®¢æˆ·ç«¯ID

        // DOMå…ƒç´ 
        const $ = id => document.getElementById(id);
        const statusEl = $('status');
        const hostBtn = $('hostBtn');
        const clientBtn = $('clientBtn');
        const modeSelect = $('modeSelect');
        const systemAudioBtn = $('systemAudioBtn');
        const micAudioBtn = $('micAudioBtn');
        const permGuide = $('permGuide');
        const guideText = $('guideText');
        const roomCard = $('roomCard');
        const roomTitle = $('roomTitle');
        const roomInput = $('roomInput');
        const serverStatus = $('serverStatus');
        const controls = $('controls');
        const startBtn = $('startBtn');
        const stopBtn = $('stopBtn');
        const testAudioBtn = $('testAudioBtn');

        // æƒé™é”™è¯¯æç¤ºï¼ˆä¾›Javaè°ƒç”¨ï¼‰
        window.showPermissionError = function() {
            statusEl.textContent = 'âŒ æƒé™è¢«æ‹’ç»ï¼è¯·åœ¨ç³»ç»Ÿè®¾ç½®ä¸­æ‰‹åŠ¨å¼€å¯æƒé™';
            guideText.innerHTML = `
                è¯·æ‰‹åŠ¨å¼€å¯æƒé™ï¼š<br>
                1. è®¾ç½® â†’ åº”ç”¨ â†’ å®æ—¶éŸ³é¢‘å…±äº« â†’ æƒé™<br>
                2. å¼€å¯ã€Œéº¦å…‹é£ã€ã€ŒéŸ³é¢‘ã€ã€Œå­˜å‚¨ã€æƒé™<br>
                3. é‡å¯åº”ç”¨åé‡è¯•
            `;
            permGuide.style.display = 'block';
        };

        // æ˜¾ç¤ºæƒé™å¼•å¯¼
        function showPermGuide(mode) {
            permGuide.style.display = 'block';
            if (mode === "system") {
                guideText.innerHTML = `
                    ç³»ç»ŸéŸ³é¢‘å¼€å¯æ­¥éª¤ï¼š<br>
                    1. ç‚¹å‡»æŒ‰é’®åï¼Œç³»ç»Ÿä¼šæç¤º"å½•åˆ¶å±å¹•/éŸ³é¢‘"<br>
                    2. é€‰æ‹©"å…è®¸"ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¼€å§‹å½•åˆ¶éŸ³é¢‘<br>
                    3. è‹¥æ²¡æœ‰æç¤ºï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿè®¾ç½®ä¸­çš„æƒé™
                `;
            } else {
                guideText.innerHTML = `
                    éº¦å…‹é£å¼€å¯æ­¥éª¤ï¼š<br>
                    1. ç‚¹å‡»æŒ‰é’®åï¼Œç³»ç»Ÿä¼šæç¤º"ä½¿ç”¨éº¦å…‹é£"<br>
                    2. é€‰æ‹©"å…è®¸"å³å¯<br>
                    3. æ’­æ”¾éŸ³ä¹æ—¶è¯·å°†æ‰‹æœºéŸ³é‡è°ƒå¤§
                `;
            }
        }

        // ç”Ÿæˆ6ä½æˆ¿é—´å·
        function generateRoomId() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // æ›´æ–°æœåŠ¡å™¨çŠ¶æ€
        function updateServerStatus(status, message) {
            serverStatus.className = `server-status ${status}`;
            serverStatus.textContent = message;
        }

        // ç”Ÿæˆå®¢æˆ·ç«¯ID
        function generateClientId() {
            return Math.random().toString(36).substr(2, 9);
        }

        // WebRTCé…ç½®
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // åˆ›å»ºWebRTCå¯¹ç­‰è¿æ¥
        function createPeerConnection(remoteId) {
            const pc = new RTCPeerConnection(rtcConfig);
            
            // æ·»åŠ æœ¬åœ°éŸ³é¢‘æµ
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });
            }
            
            // å¤„ç†ICEå€™é€‰
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    // é€šè¿‡æ•°æ®é€šé“å‘é€ICEå€™é€‰
                    if (dataChannel && dataChannel.readyState === 'open') {
                        dataChannel.send(JSON.stringify({
                            type: 'ice-candidate',
                            candidate: event.candidate,
                            to: remoteId,
                            from: clientId
                        }));
                    }
                }
            };
            
            // å¤„ç†è¿œç¨‹æµ
            pc.ontrack = (event) => {
                // æ’­æ”¾è¿œç¨‹éŸ³é¢‘
                const remoteAudio = document.getElementById('remoteAudio');
                if (remoteAudio) {
                    remoteAudio.srcObject = event.streams[0];
                    remoteAudio.play().catch(e => console.log('æ’­æ”¾å¤±è´¥:', e));
                }
            };
            
            // å¤„ç†è¿æ¥çŠ¶æ€å˜åŒ–
            pc.onconnectionstatechange = () => {
                console.log('è¿æ¥çŠ¶æ€:', pc.connectionState);
                updateConnectionStatus(pc.connectionState);
            };
            
            return pc;
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
        function updateConnectionStatus(state) {
            switch (state) {
                case 'connected':
                    updateServerStatus('connected', 'ğŸŸ¢ è®¾å¤‡è¿æ¥æˆåŠŸ');
                    break;
                case 'connecting':
                    updateServerStatus('connecting', 'ğŸŸ¡ æ­£åœ¨è¿æ¥è®¾å¤‡...');
                    break;
                case 'disconnected':
                case 'failed':
                    updateServerStatus('disconnected', 'ğŸ”´ è®¾å¤‡è¿æ¥æ–­å¼€');
                    break;
                case 'closed':
                    updateServerStatus('offline', 'âšª è¿æ¥å·²å…³é—­');
                    break;
            }
        }

        // åˆå§‹åŒ–WebRTCæ•°æ®é€šé“ï¼ˆç”¨äºæˆ¿é—´å‘ç°å’Œä¿¡ä»¤ï¼‰
        function initDataChannel() {
            // åœ¨æœ¬åœ°æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ç®€å•çš„æˆ¿é—´ç®¡ç†
            statusEl.textContent = 'ğŸ“¶ æœ¬åœ°ç½‘ç»œæ¨¡å¼å·²å°±ç»ª';
            updateServerStatus('connected', 'ğŸŸ¢ æœ¬åœ°ç½‘ç»œå°±ç»ª');
        }

        // ç®€åŒ–çš„è¿æ¥å‡½æ•°ï¼ˆæ›¿ä»£WebSocketï¼‰
        async function connectWebSocket() {
            // åœ¨æœ¬åœ°æ¨¡å¼ä¸‹ï¼Œç›´æ¥åˆå§‹åŒ–WebRTC
            initDataChannel();
            return true;
        }

        // å¤„ç†æ¶ˆæ¯ï¼ˆæœ¬åœ°ç½‘ç»œæ¨¡å¼ï¼‰
        function handleWebSocketMessage(data) {
            try {
                const message = JSON.parse(data);
                
                switch (message.type) {
                    case 'room_created':
                        handleRoomCreated(message);
                        break;
                    case 'room_joined':
                        handleRoomJoined(message);
                        break;
                    case 'user_joined':
                        handleUserJoined(message);
                        break;
                    case 'audio_data':
                        handleAudioData(message);
                        break;
                    case 'user_left':
                        handleUserLeft(message);
                        break;
                    case 'error':
                        handleError(message);
                        break;
                }
            } catch (error) {
                console.log('æ”¶åˆ°éJSONæ¶ˆæ¯:', data);
                // åœ¨æœ¬åœ°æ¨¡å¼ä¸‹ï¼Œæ¨¡æ‹Ÿå“åº”
                simulateServerResponse(data);
            }
        }

        // æ¨¡æ‹ŸéŸ³é¢‘æ•°æ®ä¼ è¾“ï¼ˆç”¨äºæµ‹è¯•ï¼‰
        function simulateAudioTransmission() {
            if (!isHost || !currentRoomId) {
                statusEl.textContent = 'âš ï¸ è¯·å…ˆåˆ›å»ºæˆ¿é—´å¹¶å¼€å§‹ä¼ å£°';
                return;
            }
            
            statusEl.textContent = 'ğŸ”Š å¼€å§‹æ¨¡æ‹ŸéŸ³é¢‘ä¼ è¾“æµ‹è¯•...';
            
            // åˆ›å»ºæµ‹è¯•éŸ³é¢‘æ•°æ®
            const sampleRate = 44100;
            const frameCount = 1024;
            const audioData = new Float32Array(frameCount);
            
            // ç”Ÿæˆ440Hz sine wave
            for (let i = 0; i < frameCount; i++) {
                audioData[i] = Math.sin(440 * Math.PI * 2 * i / sampleRate) * 0.5;
            }
            
            // æ¨¡æ‹Ÿå‘é€éŸ³é¢‘æ•°æ®
            const message = {
                type: 'audio_data',
                roomId: currentRoomId,
                data: Array.from(audioData),
                timestamp: Date.now()
            };
            
            // ç›´æ¥å¤„ç†éŸ³é¢‘æ•°æ®ï¼ˆæ¨¡æ‹Ÿæ¥æ”¶ç«¯ï¼‰
            setTimeout(() => {
                handleAudioData(message);
                statusEl.textContent = 'âœ… éŸ³é¢‘ä¼ è¾“æµ‹è¯•æˆåŠŸï¼å¯ä»¥æ­£å¸¸ä¼ å£°';
            }, 1000);
        }

        // æˆ¿é—´å‘ç°åŠŸèƒ½ï¼ˆæœ¬åœ°ç½‘ç»œï¼‰
        function startRoomDiscovery(roomId) {
            // åœ¨æœ¬åœ°ç½‘ç»œæ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬ç®€åŒ–å¤„ç†
            console.log(`å¼€å§‹æˆ¿é—´å‘ç°ï¼š${roomId}`);
            
            // åˆ›å»ºä¸€ä¸ªç®€å•çš„æˆ¿é—´ä¿¡æ¯å¹¿æ’­
            const roomInfo = {
                roomId: roomId,
                hostId: clientId,
                timestamp: Date.now(),
                name: `éŸ³é¢‘æˆ¿é—´-${roomId}`
            };
            
            // å­˜å‚¨æˆ¿é—´ä¿¡æ¯ä»¥ä¾¿å…¶ä»–è®¾å¤‡å‘ç°
            localStorage.setItem(`room_${roomId}`, JSON.stringify(roomInfo));
            
            // å®šæœŸæ¸…ç†è¿‡æœŸæˆ¿é—´
            setInterval(() => {
                cleanupExpiredRooms();
            }, 60000); // æ¯åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
        }

        // æ¸…ç†è¿‡æœŸæˆ¿é—´
        function cleanupExpiredRooms() {
            const now = Date.now();
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('room_')) {
                    try {
                        const roomInfo = JSON.parse(localStorage.getItem(key));
                        if (now - roomInfo.timestamp > 3600000) { // 1å°æ—¶è¿‡æœŸ
                            localStorage.removeItem(key);
                        }
                    } catch (e) {
                        localStorage.removeItem(key);
                    }
                }
            }
        }

        // æŸ¥æ‰¾æœ¬åœ°ç½‘ç»œä¸­çš„æˆ¿é—´
        function findLocalRooms() {
            const rooms = [];
            const now = Date.now();
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('room_')) {
                    try {
                        const roomInfo = JSON.parse(localStorage.getItem(key));
                        if (now - roomInfo.timestamp < 3600000) { // 1å°æ—¶å†…æœ‰æ•ˆ
                            rooms.push(roomInfo);
                        }
                    } catch (e) {
                        localStorage.removeItem(key);
                    }
                }
            }
            
            return rooms;
        }

        // æ¨¡æ‹ŸæœåŠ¡å™¨å“åº”ï¼ˆå› ä¸ºä½¿ç”¨å…¬å…±echoæœåŠ¡å™¨ï¼‰
        function simulateServerResponse(data) {
            try {
                const message = JSON.parse(data);
                
                // æ¨¡æ‹Ÿæˆ¿é—´åˆ›å»ºå“åº”
                if (message.type === 'create_room') {
                    const simulatedResponse = {
                        type: 'room_created',
                        roomId: message.roomId,
                        message: 'æˆ¿é—´åˆ›å»ºæˆåŠŸ'
                    };
                    handleRoomCreated(simulatedResponse);
                }
                
                // æ¨¡æ‹ŸåŠ å…¥æˆ¿é—´å“åº”
                else if (message.type === 'join_room') {
                    const simulatedResponse = {
                        type: 'room_joined',
                        roomId: message.roomId,
                        message: 'æˆåŠŸåŠ å…¥æˆ¿é—´'
                    };
                    handleRoomJoined(simulatedResponse);
                }
                
            } catch (error) {
                console.log('æ— æ³•è§£ææ¶ˆæ¯:', data);
            }
        }

        // å¤„ç†æˆ¿é—´åˆ›å»ºå“åº”
        function handleRoomCreated(message) {
            currentRoomId = message.roomId;
            roomInput.value = currentRoomId;
            roomTitle.textContent = `æˆ¿é—´å·ï¼š${currentRoomId}ï¼ˆè¯·åˆ†äº«ç»™æ”¶å¬æ–¹ï¼‰`;
            statusEl.textContent = `âœ… æˆ¿é—´åˆ›å»ºæˆåŠŸ | æˆ¿é—´å·ï¼š${currentRoomId}`;
            startBtn.disabled = false;
            controls.style.display = 'flex';
        }

        // å¤„ç†åŠ å…¥æˆ¿é—´å“åº”
        function handleRoomJoined(message) {
            currentRoomId = message.roomId;
            roomInput.value = currentRoomId;
            roomTitle.textContent = `å·²åŠ å…¥æˆ¿é—´ï¼š${currentRoomId}`;
            statusEl.textContent = `âœ… æˆåŠŸåŠ å…¥æˆ¿é—´ | ç­‰å¾…æ’­æ”¾æ–¹å¼€å§‹ä¼ å£°`;
        }

        // å¤„ç†ç”¨æˆ·åŠ å…¥
        function handleUserJoined(message) {
            statusEl.textContent = `ğŸ‘¥ æœ‰ç”¨æˆ·åŠ å…¥æˆ¿é—´ | å½“å‰äººæ•°ï¼š${message.userCount}`;
        }

        // å¤„ç†éŸ³é¢‘æ•°æ®
        function handleAudioData(message) {
            if (!isHost) {
                playAudioData(message.data);
            }
        }

        // å¤„ç†ç”¨æˆ·ç¦»å¼€
        function handleUserLeft(message) {
            statusEl.textContent = `ğŸ‘¥ ç”¨æˆ·ç¦»å¼€æˆ¿é—´ | å½“å‰äººæ•°ï¼š${message.userCount}`;
        }

        // å¤„ç†é”™è¯¯æ¶ˆæ¯
        function handleError(message) {
            statusEl.textContent = `âŒ é”™è¯¯ï¼š${message.message}`;
        }

        // åˆ›å»ºæˆ¿é—´
        function createRoom() {
            const roomId = roomInput.value.trim() || generateRoomId();
            currentRoomId = roomId;
            
            statusEl.textContent = `ğŸ“ åˆ›å»ºæˆ¿é—´ï¼š${roomId}...`;
            
            // éªŒè¯æˆ¿é—´å·æ ¼å¼
            if (!/^\d{6}$/.test(roomId)) {
                statusEl.textContent = 'âŒ æˆ¿é—´å·å¿…é¡»æ˜¯6ä½æ•°å­—';
                return;
            }
            
            // æ£€æŸ¥æˆ¿é—´æ˜¯å¦å·²å­˜åœ¨
            if (activeRooms.has(roomId)) {
                const roomInfo = activeRooms.get(roomId);
                const roomAge = Date.now() - roomInfo.createdAt;
                if (roomAge < 3600000) { // 1å°æ—¶å†…
                    statusEl.textContent = 'âŒ æˆ¿é—´å·å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–æˆ¿é—´å·';
                    return;
                } else {
                    // è¿‡æœŸæˆ¿é—´ï¼Œå…è®¸å¤ç”¨
                    activeRooms.delete(roomId);
                }
            }
            
            // è®°å½•æˆ¿é—´ä¿¡æ¯
            const roomInfo = {
                roomId: roomId,
                hostId: generateUserId(),
                createdAt: Date.now(),
                lastActive: Date.now(),
                userCount: 1
            };
            activeRooms.set(roomId, roomInfo);
            roomCreationTime = Date.now();
            
            const message = {
                type: 'create_room',
                roomId: roomId,
                userId: roomInfo.hostId,
                timestamp: Date.now()
            };
            
            sendWebSocketMessage(message);
            
            // ç”±äºæ˜¯æ¨¡æ‹ŸæœåŠ¡å™¨ï¼Œç›´æ¥å¤„ç†å“åº”
            setTimeout(() => {
                handleRoomCreated({
                    type: 'room_created',
                    roomId: roomId,
                    message: 'æˆ¿é—´åˆ›å»ºæˆåŠŸ'
                });
            }, 1000);
        }

        // åŠ å…¥æˆ¿é—´
        function joinRoom(roomId) {
            statusEl.textContent = `ğŸ“¥ åŠ å…¥æˆ¿é—´ï¼š${roomId}...`;
            
            // éªŒè¯æˆ¿é—´å·æ ¼å¼
            if (!/^\d{6}$/.test(roomId)) {
                statusEl.textContent = 'âŒ æˆ¿é—´å·å¿…é¡»æ˜¯6ä½æ•°å­—';
                return;
            }
            
            // æ£€æŸ¥æˆ¿é—´æ˜¯å¦å­˜åœ¨
            if (!activeRooms.has(roomId)) {
                statusEl.textContent = 'âŒ æˆ¿é—´ä¸å­˜åœ¨ | è¯·æ£€æŸ¥æˆ¿é—´å·';
                return;
            }
            
            // æ£€æŸ¥æˆ¿é—´æ˜¯å¦è¿‡æœŸ
            const roomInfo = activeRooms.get(roomId);
            const roomAge = Date.now() - roomInfo.createdAt;
            if (roomAge > 3600000) { // 1å°æ—¶è¿‡æœŸ
                statusEl.textContent = 'âŒ æˆ¿é—´å·²è¿‡æœŸ | è¯·é‡æ–°åˆ›å»º';
                activeRooms.delete(roomId);
                return;
            }
            
            // æ£€æŸ¥æˆ¿é—´æ˜¯å¦æœ‰æ’­æ”¾æ–¹
            if (!roomInfo.hostId) {
                statusEl.textContent = 'âŒ æˆ¿é—´æ— æ’­æ”¾æ–¹ | è¯·ç­‰å¾…æ’­æ”¾æ–¹åŠ å…¥';
                return;
            }
            
            // æ›´æ–°æˆ¿é—´ä¿¡æ¯
            roomInfo.userCount++;
            roomInfo.lastActive = Date.now();
            activeRooms.set(roomId, roomInfo);
            
            const userId = generateUserId();
            const message = {
                type: 'join_room',
                roomId: roomId,
                userId: userId,
                timestamp: Date.now()
            };
            
            sendWebSocketMessage(message);
            
            // ç”±äºæ˜¯æ¨¡æ‹ŸæœåŠ¡å™¨ï¼Œç›´æ¥å¤„ç†å“åº”
            setTimeout(() => {
                handleRoomJoined({
                    type: 'room_joined',
                    roomId: roomId,
                    userId: userId,
                    message: 'æˆåŠŸåŠ å…¥æˆ¿é—´'
                });
            }, 1000);
        }

        // ç”Ÿæˆç”¨æˆ·ID
        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9);
        }

        // å‘é€WebSocketæ¶ˆæ¯
        function sendWebSocketMessage(message) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify(message));
            } else {
                console.log('WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯');
            }
        }

        // ç³»ç»ŸéŸ³é¢‘æ•è·
        async function captureSystemAudio() {
            audioMode = "system";
            showPermGuide("system");
            statusEl.textContent = 'ğŸ”„ ç”³è¯·ç³»ç»ŸéŸ³é¢‘æƒé™...';

            try {
                // APKç‰ˆæœ¬ç›´æ¥ä½¿ç”¨getDisplayMedia
                audioStream = await navigator.mediaDevices.getDisplayMedia({
                    audio: { echoCancellation: false, noiseSuppression: false },
                    video: false
                });
                statusEl.textContent = 'âœ… ç³»ç»ŸéŸ³é¢‘æ•è·æˆåŠŸï¼ˆæ— æ‚éŸ³ï¼‰';
                setupAudioContext();
                roomCard.style.display = 'block';
            } catch (err) {
                statusEl.textContent = `âŒ ç³»ç»ŸéŸ³é¢‘å¤±è´¥ï¼š${err.message}`;
                captureMicAudio(); // é™çº§åˆ°éº¦å…‹é£
            }
        }

        // éº¦å…‹é£æ•è·
        async function captureMicAudio() {
            audioMode = "mic";
            showPermGuide("mic");
            statusEl.textContent = 'ğŸ”„ ç”³è¯·éº¦å…‹é£æƒé™...';

            try {
                audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false,
                        sampleRate: 48000
                    },
                    video: false
                });
                statusEl.textContent = 'âœ… éº¦å…‹é£æƒé™ç”³è¯·æˆåŠŸ';
                setupAudioContext();
                roomCard.style.display = 'block';
            } catch (err) {
                statusEl.textContent = `âŒ éº¦å…‹é£å¤±è´¥ï¼š${err.name} - ${err.message}`;
                guideText.innerHTML += `<br><br>ğŸ’¡ è¯·åœ¨ç³»ç»Ÿè®¾ç½®ä¸­æ‰‹åŠ¨å¼€å¯æƒé™`;
            }
        }

        // è®¾ç½®éŸ³é¢‘ä¸Šä¸‹æ–‡
        function setupAudioContext() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioTrack = audioStream.getAudioTracks()[0];
                audioSource = audioContext.createMediaStreamSource(audioStream);
                
                // åˆ›å»ºéŸ³é¢‘å¤„ç†å™¨
                audioProcessor = audioContext.createScriptProcessor(4096, 1, 1);
                
                audioProcessor.onaudioprocess = (e) => {
                    if (isSharing && isHost) {
                        const inputData = e.inputBuffer.getChannelData(0);
                        const audioData = Array.from(inputData);
                        
                        // å‘é€éŸ³é¢‘æ•°æ®
                        const message = {
                            type: 'audio_data',
                            roomId: currentRoomId,
                            data: audioData,
                            timestamp: Date.now()
                        };
                        
                        sendWebSocketMessage(message);
                    }
                };
                
                audioSource.connect(audioProcessor);
                audioProcessor.connect(audioContext.destination);
                
            } catch (error) {
                statusEl.textContent = `âŒ è®¾ç½®éŸ³é¢‘å¤±è´¥ï¼š${error.message}`;
            }
        }

        // æ’­æ”¾éŸ³é¢‘æ•°æ®
        function playAudioData(audioData) {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // æ¢å¤AudioContextï¼ˆè§£å†³è‡ªåŠ¨æ’­æ”¾ç­–ç•¥é™åˆ¶ï¼‰
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                const buffer = audioContext.createBuffer(1, audioData.length, audioContext.sampleRate);
                const channelData = buffer.getChannelData(0);
                
                for (let i = 0; i < audioData.length; i++) {
                    channelData[i] = audioData[i];
                }
                
                const source = audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(audioContext.destination);
                source.start(0);
                
            } catch (error) {
                console.log('æ’­æ”¾éŸ³é¢‘å¤±è´¥:', error);
                statusEl.textContent = `âš ï¸ éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼š${error.message}`;
            }
        }

        // æ¨¡æ‹ŸéŸ³é¢‘æ’­æ”¾ï¼ˆç”¨äºæ¼”ç¤ºï¼‰
        function simulateAudioPlayback() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // åˆ›å»ºæµ‹è¯•éŸ³é¢‘ï¼ˆ440Hz sine waveï¼‰
                const sampleRate = audioContext.sampleRate;
                const duration = 0.5; // 0.5ç§’
                const frameCount = sampleRate * duration;
                
                const buffer = audioContext.createBuffer(1, frameCount, sampleRate);
                const channelData = buffer.getChannelData(0);
                
                for (let i = 0; i < frameCount; i++) {
                    channelData[i] = Math.sin(440 * Math.PI * 2 * i / sampleRate) * 0.5;
                }
                
                const source = audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(audioContext.destination);
                source.start(0);
                
                statusEl.textContent = 'ğŸ”Š æµ‹è¯•éŸ³é¢‘æ’­æ”¾æˆåŠŸ';
            } catch (error) {
                console.log('æµ‹è¯•éŸ³é¢‘æ’­æ”¾å¤±è´¥:', error);
                statusEl.textContent = `âŒ éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼š${error.message} | è¯·ç‚¹å‡»å±å¹•ä»»æ„ä½ç½®`;
                
                // æ·»åŠ ç”¨æˆ·äº¤äº’ç›‘å¬
                document.body.addEventListener('click', () => {
                    if (audioContext && audioContext.state === 'suspended') {
                        audioContext.resume();
                        simulateAudioPlayback();
                    }
                }, { once: true });
            }
        }

        // å¼€å§‹ä¼ å£°
        function startSharing() {
            if (!currentRoomId) {
                statusEl.textContent = 'âš ï¸ è¯·å…ˆåˆ›å»ºæˆ–åŠ å…¥æˆ¿é—´';
                return;
            }
            
            if (!audioStream || !audioTrack) {
                statusEl.textContent = 'âš ï¸ è¯·å…ˆè·å–éŸ³é¢‘æƒé™';
                return;
            }
            
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            isSharing = true;
            audioTrack.enabled = true;
            
            statusEl.textContent = `â–¶ï¸ æ­£åœ¨å®æ—¶ä¼ å£°ï¼ˆ${audioMode}æ¨¡å¼ï¼‰`;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            
            // å‘é€å¼€å§‹ä¼ å£°é€šçŸ¥
            const message = {
                type: 'start_sharing',
                roomId: currentRoomId,
                timestamp: Date.now()
            };
            
            sendWebSocketMessage(message);
        }

        // åœæ­¢ä¼ å£°
        function stopSharing() {
            isSharing = false;
            
            if (audioTrack) {
                audioTrack.enabled = false;
            }
            
            if (audioContext && audioContext.state === 'running') {
                audioContext.suspend();
            }
            
            statusEl.textContent = 'â¹ï¸ å·²åœæ­¢ä¼ å£° | å¯é‡æ–°å¼€å§‹';
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            // å‘é€åœæ­¢ä¼ å£°é€šçŸ¥
            const message = {
                type: 'stop_sharing',
                roomId: currentRoomId,
                timestamp: Date.now()
            };
            
            sendWebSocketMessage(message);
        }

        // æˆ¿é—´è¾“å…¥å¤„ç†
        roomInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const roomId = roomInput.value.trim();
                if (roomId) {
                    if (isHost) {
                        createRoom();
                    } else {
                        joinRoom(roomId);
                    }
                }
            }
        });

        // è§’è‰²é€‰æ‹©
        hostBtn.addEventListener('click', async () => {
            isHost = true;
            statusEl.textContent = 'ğŸ“¤ è¯·é€‰æ‹©éŸ³é¢‘æ•è·æ¨¡å¼ï¼ˆä¼˜å…ˆç³»ç»ŸéŸ³é¢‘ï¼‰';
            modeSelect.style.display = 'flex';
            clientBtn.disabled = true;
            showPermGuide("system");
            
            // è¿æ¥WebSocketæœåŠ¡å™¨
            await connectWebSocket();
        });

        clientBtn.addEventListener('click', async () => {
            isHost = false;
            statusEl.textContent = 'ğŸ“¥ è¯·è¾“å…¥æˆ¿é—´å·åŠ å…¥æˆ¿é—´';
            roomCard.style.display = 'block';
            roomTitle.textContent = 'è¾“å…¥æˆ¿é—´å·åŠ å…¥';
            hostBtn.disabled = true;
            
            // è¿æ¥WebSocketæœåŠ¡å™¨
            await connectWebSocket();
        });

        // ç»‘å®šéŸ³é¢‘æ¨¡å¼æŒ‰é’®
        systemAudioBtn.addEventListener('click', captureSystemAudio);
        micAudioBtn.addEventListener('click', captureMicAudio);

        // ç»‘å®šæ§åˆ¶æŒ‰é’®
        startBtn.addEventListener('click', startSharing);
        stopBtn.addEventListener('click', stopSharing);
        
        // ç»‘å®šæµ‹è¯•æŒ‰é’®
        testAudioBtn.addEventListener('click', () => {
            simulateAudioTransmission();
        });

        // é¡µé¢åˆå§‹åŒ–
        window.onload = () => {
            statusEl.textContent = 'âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ | è¯·é€‰æ‹©è§’è‰²';
            // æ˜¾ç¤ºéŸ³é¢‘æµ‹è¯•æ§ä»¶
            audioTestControls.style.display = 'flex';
            
            // å°è¯•è¿æ¥WebSocketæœåŠ¡å™¨
            setTimeout(() => {
                connectWebSocket();
            }, 1000);
        };

        // æ·»åŠ å…¨å±€ç‚¹å‡»ç›‘å¬å™¨ï¼ˆè§£å†³è‡ªåŠ¨æ’­æ”¾é™åˆ¶ï¼‰
        document.body.addEventListener('click', () => {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
                statusEl.textContent = 'ğŸ”Š éŸ³é¢‘ä¸Šä¸‹æ–‡å·²æ¢å¤';
            }
        }, { once: true });
    </script>
</body>
</html>